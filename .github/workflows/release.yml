name: Build and Release DEB Package

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-deb:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y devscripts equivs
        sudo mk-build-deps -i -r -t "apt-get -y --no-install-recommends" debian/control
      
    - name: Build DEB package
      run: |
        dpkg-buildpackage -us -uc -b
        mkdir -p builddir
        mv ../obision-app-optional-soft_*.deb builddir/obision-app-optional-soft.deb
        
    - name: Verify DEB exists
      run: |
        if [ ! -f builddir/obision-app-optional-soft.deb ]; then
          echo "ERROR: DEB file not found!"
          echo "Contents of builddir:"
          ls -la builddir/ || echo "builddir not found"
          echo "Contents of parent dir:"
          ls -la ../
          exit 1
        fi
        echo "✅ DEB file found:"
        ls -lh builddir/obision-app-optional-soft.deb
      
    - name: Create Release and Upload DEB
      uses: softprops/action-gh-release@v1
      with:
        files: builddir/obision-app-optional-soft.deb
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload to obision-packages repository
      env:
        DEPLOY_KEY: ${{ secrets.OBISION_PACKAGES_DEPLOY_KEY }}
      run: |
        # Extract version from tag
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "Version: $VERSION"
        
        # Configure git
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # Setup SSH key for obision-packages repo
        mkdir -p ~/.ssh
        echo "$DEPLOY_KEY" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan github.com >> ~/.ssh/known_hosts
        
        # Clone obision-packages repository
        cd ..
        git clone git@github.com:nirlob/obision-packages.git
        cd obision-packages
        
        # Create debs directory if it doesn't exist
        mkdir -p debs
        
        # Remove old versions of the package
        rm -f debs/obision-app-optional-soft_*.deb
        
        # Copy the .deb file with versioned name
        cp ../obision-app-optional-soft/builddir/obision-app-optional-soft.deb \
           debs/obision-app-optional-soft_${VERSION}_all.deb
        
        # Regenerate Packages file
        dpkg-scanpackages --arch all --multiversion debs /dev/null > Packages
        gzip -k -f Packages
        
        # Commit and push (including deletions)
        git add -A debs/
        git add Packages Packages.gz
        git commit -m "Update obision-app-optional-soft to version $VERSION"
        git push origin master
        
        echo "✅ Package uploaded to obision-packages repository"
